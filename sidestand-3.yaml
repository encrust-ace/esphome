esphome:
  name: sidestand-3
  friendly_name: "Sidestand-3"

esp8266:
  board: nodemcuv2
  restore_from_flash: true
  framework:
    version: recommended
    
logger:
  level: WARN  # Reduce logging to save memory

api:
ota:
  - platform: esphome

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  reboot_timeout: 5min  # Increased timeout
  ap:
    ssid: "Sidestand-3 Fallback Hotspot"
    password: "12345678"

captive_portal:
web_server:
improv_serial:
wled:

# ========== SENSORS ==========
sensor:
  # WiFi Signal Strength
  - platform: wifi_signal
    name: "WiFi Signal (dBm)"
    id: wifi_signal_db
    update_interval: 60s
    entity_category: "diagnostic"

  - platform: template
    name: "WiFi Signal"
    unit_of_measurement: "%"
    id: wifi_signal_percent
    update_interval: 60s
    entity_category: "diagnostic"
    icon: "mdi:wifi"
    lambda: |-
      float rssi = id(wifi_signal_db).state;
      float percentage = 2.0 * (rssi + 100.0);
      return std::min(100.0f, std::max(0.0f, percentage));

  # Uptime in seconds
  - platform: uptime
    name: "Uptime"
    unit_of_measurement: "s"
    entity_category: "diagnostic"

  # Free Heap (RAM)
  - platform: template
    name: "Free Heap"
    lambda: 'return (float)ESP.getFreeHeap();'
    unit_of_measurement: "bytes"
    update_interval: 60s
    entity_category: "diagnostic"

# ========== TEXT SENSORS ==========
text_sensor:
  # WiFi Info
  - platform: wifi_info
    ip_address:
      name: "IP Address"
      icon: "mdi:ip-network"
      entity_category: "diagnostic"
    ssid:
      name: "Connected SSID"
      icon: "mdi:wifi"
      entity_category: "diagnostic"
    mac_address:
      name: "MAC Address"
      icon: "mdi:ethernet"
      entity_category: "diagnostic"

# ========== LIGHT ==========

globals:
  - id: current_palette
    type: int
    initial_value: '0'  # 0=Aurora, 1=Ocean, 2=Fire, 3=Neon, 4=Forest, 5=Sunset, 6=Ice, 7=Galaxy, 8=Sakura, 9=Electric

  - id: speed
    type: int
    initial_value: '0'

  - id: reverse_effect
    type: bool
    initial_value: 'false'

  - id: gradient_offset
    type: float
    initial_value: '0.0'

select:
  - platform: template
    name: Palette
    options:
      - Default
      - Aurora
      - Ocean
      - Fire
      - Neon
      - Forest
      - Sunset
      - Ice
      - Galaxy
      - Sakura
      - Electric
    initial_option: Aurora
    set_action: 
      then:
        - lambda: |-
            if (x == "Default") id(current_palette) = 10;
            else if (x == "Aurora") id(current_palette) = 0;
            else if (x == "Ocean") id(current_palette) = 1;
            else if (x == "Fire") id(current_palette) = 2;
            else if (x == "Neon") id(current_palette) = 3;
            else if (x == "Forest") id(current_palette) = 4;
            else if (x == "Sunset") id(current_palette) = 5;
            else if (x == "Ice") id(current_palette) = 6;
            else if (x == "Galaxy") id(current_palette) = 7;
            else if (x == "Sakura") id(current_palette) = 8;
            else if (x == "Electric") id(current_palette) = 9;

number:
  - platform: template
    name: Speed
    step: 1
    min_value: 0
    max_value: 10
    set_action: 
      then:
        - lambda: |-
            id(speed) = (int)x;

switch:
  - platform: template
    name: Reverse
    turn_on_action: 
      then:
        - lambda: |-
            id(reverse_effect) = true;
    turn_off_action:
      then:
        - lambda: |-
            id(reverse_effect) = false;

light:
  - platform: neopixelbus
    type: GRB
    variant: WS2812X
    pin: GPIO02
    num_leds: 87
    id: strip_light
    name: "Light"
    restore_mode: RESTORE_DEFAULT_OFF
    effects: !include shared/effects.yaml

  - platform: partition
    name: "Segment 1"
    segments: 
      - id: strip_light
        from: 0
        to: 20
        
  - platform: partition
    name: "Segment 2"
    segments: 
      - id: strip_light
        from: 21
        to: 42
        
  - platform: partition
    name: "Segment 3"
    segments: 
      - id: strip_light
        from: 43
        to: 64
        
  - platform: partition
    name: "Segment 4"
    segments: 
      - id: strip_light
        from: 65
        to: 86